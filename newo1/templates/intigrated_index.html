<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot Control - Gaming Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: white;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* Full Screen Camera Background */
        .camera-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
            background: #111;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.9;
        }

        .camera-offline {
            font-size: 24px;
            color: #666;
            text-align: center;
        }

        /* HUD Overlay */
        .hud-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10;
            pointer-events: none;
        }

        /* Top Status Bar */
        .top-hud {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,20,40,0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 25px;
            padding: 8px 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            font-size: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }

        .status-green { background: #4CAF50; }
        .status-red { background: #ff4444; }
        .status-orange { background: #ff9800; }

        /* Connection Status (Top Right) */
        .connection-status {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,20,40,0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 11px;
            font-weight: bold;
        }

        .connected { border-color: #4CAF50; color: #4CAF50; }
        .disconnected { border-color: #ff4444; color: #ff4444; }

        /* Bottom HUD Panel */
        .bottom-hud {
            position: absolute;
            bottom: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        /* Left Panel - Motor Status & GPS */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .info-panel {
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,20,40,0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 10px;
            min-width: 200px;
        }

        .info-panel h4 {
            font-size: 12px;
            margin-bottom: 5px;
            color: #aaa;
        }

        .motor-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            font-size: 11px;
            font-family: monospace;
        }

        .motor-active {
            color: #4CAF50;
            font-weight: bold;
        }

        /* Right Panel - Joystick */
        .joystick-panel {
            pointer-events: auto;
            position: relative;
        }

        .joystick-container {
            width: 140px;
            height: 140px;
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,20,40,0.8));
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            touch-action: none;
        }

        .joystick-zones {
            position: absolute;
            inset: 8px;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                rgba(255,0,0,0.1) 0deg 90deg,
                rgba(0,255,0,0.1) 90deg 180deg,
                rgba(255,0,0,0.1) 180deg 270deg,
                rgba(0,0,255,0.1) 270deg 360deg
            );
        }

        .joystick-deadzone {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            transform: translate(-50%, -50%);
            border: 1px dashed rgba(255,255,255,0.3);
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
        }

        .joystick-handle {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
            transition: all 0.1s ease;
        }

        .joystick-handle:active {
            cursor: grabbing;
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.8);
        }

        .joystick-coordinates {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-family: monospace;
            font-size: 10px;
            color: #aaa;
            text-align: center;
            white-space: nowrap;
        }

        /* Emergency Button */
        .emergency-btn {
            position: absolute;
            top: -60px;
            right: 0;
            background: linear-gradient(135deg, #ff4444, #cc0000);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 25px;
            padding: 8px 15px;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.4);
            transition: all 0.2s ease;
            pointer-events: auto;
        }

        .emergency-btn:hover {
            background: linear-gradient(135deg, #ff6666, #ff0000);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
        }

        .emergency-btn:active {
            transform: translateY(0);
        }

        /* LiDAR Mini Map */
        .lidar-minimap {
            position: absolute;
            top: 60px;
            left: 15px;
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,20,40,0.8));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            pointer-events: auto;
        }

        .lidar-canvas {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }

        .lidar-header {
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 10px;
            color: #aaa;
        }

        /* Direction Indicators */
        .direction-indicators {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .direction-label {
            position: absolute;
            font-size: 9px;
            color: rgba(255,255,255,0.6);
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }

        .dir-forward {
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
        }

        .dir-backward {
            bottom: -80px;
            left: 50%;
            transform: translateX(-50%);
        }

        .dir-left {
            left: -80px;
            top: 50%;
            transform: translateY(-50%);
        }

        .dir-right {
            right: -80px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Speed Indicators */
        .speed-indicator {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
        }

        .speed-bar {
            width: 3px;
            height: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        .speed-bar.active {
            background: linear-gradient(to top, #4CAF50, #8BC34A);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .joystick-container {
                width: 120px;
                height: 120px;
            }
            
            .joystick-handle {
                width: 30px;
                height: 30px;
            }
            
            .info-panel {
                min-width: 150px;
                font-size: 10px;
            }
            
            .lidar-minimap {
                width: 120px;
                height: 120px;
            }
        }

        @media (max-height: 600px) {
            .lidar-minimap {
                display: none;
            }
            
            .emergency-btn {
                top: -50px;
            }
        }

        /* Animations */
        .pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .glow-green {
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.6);
        }

        .glow-red {
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.6);
        }
    </style>
</head>
<body>
    <!-- Full Screen Camera -->
    <div class="camera-background">
        <img class="camera-feed" id="cameraFeed" src="" alt="Camera Offline" style="display: none;">
        <div class="camera-offline" id="cameraOffline">? Robot Camera Offline</div>
    </div>

    <!-- HUD Overlay -->
    <div class="hud-overlay">
        <!-- Connection Status -->
        <div class="connection-status" id="connectionStatus">? Connecting...</div>

        <!-- Top Status Bar -->
        <div class="top-hud">
            <div class="status-item">
                <div class="status-dot" id="motorsIndicator"></div>
                <span>Motors: <span id="motorsText">--</span></span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="cameraIndicator"></div>
                <span>Camera: <span id="cameraText">--</span></span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="lidarIndicator"></div>
                <span>LiDAR: <span id="lidarText">--</span></span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="gpsIndicator"></div>
                <span>GPS: <span id="gpsText">Searching</span></span>
            </div>
        </div>

        <!-- LiDAR Mini Map -->
        <div class="lidar-minimap">
            <div class="lidar-header">? LiDAR</div>
            <canvas class="lidar-canvas" id="lidarCanvas"></canvas>
        </div>

        <!-- Bottom HUD -->
        <div class="bottom-hud">
            <!-- Left Panel - System Info -->
            <div class="left-panel">
                <!-- Motor Status -->
                <div class="info-panel">
                    <h4>?? Motors</h4>
                    <div class="motor-row">
                        <span>Forward/Back:</span>
                        <span id="motor1Status" class="motor-status">STOP</span>
                    </div>
                    <div class="motor-row">
                        <span>Left/Right:</span>
                        <span id="motor2Status" class="motor-status">STOP</span>
                    </div>
                </div>

                <!-- GPS Info -->
                <div class="info-panel">
                    <h4>? GPS</h4>
                    <div class="motor-row">
                        <span>Lat:</span>
                        <span id="gpsLat">--</span>
                    </div>
                    <div class="motor-row">
                        <span>Lon:</span>
                        <span id="gpsLon">--</span>
                    </div>
                    <div class="motor-row">
                        <span>Acc:</span>
                        <span id="gpsAcc">--</span>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Joystick Control -->
            <div class="joystick-panel">
                <!-- Emergency Button -->
                <button class="emergency-btn" id="emergencyBtn">? STOP</button>
                
                <!-- Direction Labels -->
                <div class="direction-indicators">
                    <div class="direction-label dir-forward">FORWARD</div>
                    <div class="direction-label dir-backward">BACKWARD</div>
                    <div class="direction-label dir-left">LEFT</div>
                    <div class="direction-label dir-right">RIGHT</div>
                </div>

                <!-- Joystick -->
                <div class="joystick-container" id="joystickContainer">
                    <div class="joystick-zones"></div>
                    <div class="joystick-deadzone"></div>
                    <div class="joystick-handle" id="joystickHandle"></div>
                </div>

                <!-- Coordinates Display -->
                <div class="joystick-coordinates">
                    X: <span id="coordX">0.00</span> | Y: <span id="coordY">0.00</span>
                </div>

                <!-- Speed Indicator -->
                <div class="speed-indicator" id="speedIndicator">
                    <div class="speed-bar"></div>
                    <div class="speed-bar"></div>
                    <div class="speed-bar"></div>
                    <div class="speed-bar"></div>
                    <div class="speed-bar"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== Configuration =====
        const JOYSTICK_CONFIG = {
            deadZone: 0.25,          // Larger dead zone (25% of radius)
            sensitivityCurve: 2.0,   // Exponential sensitivity curve
            minAngleStep: 15,        // Minimum angle change in degrees
            movementThreshold: 0.3,  // Minimum movement to register
            smoothing: 0.8          // Movement smoothing factor
        };

        // ===== Global Variables =====
        const socket = io();
        let isDragging = false;
        let joystickCenter = { x: 0, y: 0 };
        let joystickRadius = 0;
        let currentPosition = { x: 0, y: 0 };
        let smoothPosition = { x: 0, y: 0 };
        let lastSentPosition = { x: 0, y: 0 };
        let lidarPoints = [];
        
        // ===== DOM Elements =====
        const joystickContainer = document.getElementById('joystickContainer');
        const joystickHandle = document.getElementById('joystickHandle');
        const emergencyBtn = document.getElementById('emergencyBtn');
        const cameraFeed = document.getElementById('cameraFeed');
        const cameraOffline = document.getElementById('cameraOffline');
        const connectionStatus = document.getElementById('connectionStatus');
        const lidarCanvas = document.getElementById('lidarCanvas');
        
        // ===== Joystick Functions =====
        function initJoystick() {
            const rect = joystickContainer.getBoundingClientRect();
            joystickCenter = {
                x: rect.left + rect.width / 2,
                y: rect.top + rect.height / 2
            };
            joystickRadius = Math.min(rect.width, rect.height) / 2 - 20;
        }
        
        function applySensitivityCurve(value) {
            // Apply exponential curve for better control
            const sign = Math.sign(value);
            const abs = Math.abs(value);
            return sign * Math.pow(abs, JOYSTICK_CONFIG.sensitivityCurve);
        }
        
        function updateJoystickPosition(clientX, clientY) {
            const dx = clientX - joystickCenter.x;
            const dy = clientY - joystickCenter.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            let finalX = 0, finalY = 0;
            let isActive = false;
            
            if (distance > joystickRadius * JOYSTICK_CONFIG.deadZone) {
                isActive = true;
                
                if (distance <= joystickRadius) {
                    finalX = dx;
                    finalY = dy;
                } else {
                    // Clamp to circle boundary
                    const angle = Math.atan2(dy, dx);
                    finalX = Math.cos(angle) * joystickRadius;
                    finalY = Math.sin(angle) * joystickRadius;
                }
            }
            
            // Update handle position
            joystickHandle.style.transform = `translate(${finalX - 17.5}px, ${finalY - 17.5}px)`;
            
            // Convert to normalized coordinates with dead zone
            let normalizedX = 0, normalizedY = 0;
            
            if (isActive) {
                normalizedX = finalX / joystickRadius;
                normalizedY = -finalY / joystickRadius; // Invert Y for intuitive control
                
                // Apply sensitivity curve
                normalizedX = applySensitivityCurve(normalizedX);
                normalizedY = applySensitivityCurve(normalizedY);
                
                // Apply movement threshold
                if (Math.abs(normalizedX) < JOYSTICK_CONFIG.movementThreshold) normalizedX = 0;
                if (Math.abs(normalizedY) < JOYSTICK_CONFIG.movementThreshold) normalizedY = 0;
            }
            
            // Smooth the movement
            smoothPosition.x = smoothPosition.x * JOYSTICK_CONFIG.smoothing + normalizedX * (1 - JOYSTICK_CONFIG.smoothing);
            smoothPosition.y = smoothPosition.y * JOYSTICK_CONFIG.smoothing + normalizedY * (1 - JOYSTICK_CONFIG.smoothing);
            
            currentPosition = { 
                x: Math.round(smoothPosition.x * 100) / 100,
                y: Math.round(smoothPosition.y * 100) / 100
            };
            
            // Update display
            document.getElementById('coordX').textContent = currentPosition.x.toFixed(2);
            document.getElementById('coordY').textContent = currentPosition.y.toFixed(2);
            
            // Update speed indicator
            updateSpeedIndicator();
            
            // Send to server only if significant change
            if (Math.abs(currentPosition.x - lastSentPosition.x) > 0.05 || 
                Math.abs(currentPosition.y - lastSentPosition.y) > 0.05) {
                
                socket.emit('joystick_input', currentPosition);
                lastSentPosition = { ...currentPosition };
            }
            
            // Visual feedback
            if (isActive) {
                joystickHandle.classList.add('glow-green');
                joystickContainer.style.borderColor = 'rgba(76, 175, 80, 0.6)';
            } else {
                joystickHandle.classList.remove('glow-green');
                joystickContainer.style.borderColor = 'rgba(255,255,255,0.2)';
            }
        }
        
        function resetJoystick() {
            joystickHandle.style.transform = 'translate(-17.5px, -17.5px)';
            currentPosition = { x: 0, y: 0 };
            smoothPosition = { x: 0, y: 0 };
            lastSentPosition = { x: 0, y: 0 };
            
            document.getElementById('coordX').textContent = '0.00';
            document.getElementById('coordY').textContent = '0.00';
            
            joystickHandle.classList.remove('glow-green');
            joystickContainer.style.borderColor = 'rgba(255,255,255,0.2)';
            
            updateSpeedIndicator();
            socket.emit('joystick_input', currentPosition);
        }
        
        function updateSpeedIndicator() {
            const speedBars = document.querySelectorAll('.speed-bar');
            const totalSpeed = Math.sqrt(currentPosition.x * currentPosition.x + currentPosition.y * currentPosition.y);
            const activeCount = Math.round(totalSpeed * 5);
            
            speedBars.forEach((bar, index) => {
                if (index < activeCount) {
                    bar.classList.add('active');
                } else {
                    bar.classList.remove('active');
                }
            });
        }
        
        // ===== LiDAR Visualization =====
        function drawLidarMap() {
            const canvas = lidarCanvas;
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scale = 0.03; // Smaller scale for minimap
            
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid rings
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            [500, 1000, 1500].forEach(radius => {
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius * scale, 0, 2 * Math.PI);
                ctx.stroke();
            });
            
            // Draw LiDAR points
            const now = Date.now() / 1000;
            lidarPoints.forEach(point => {
                if (point.age > 1.0) return; // Only recent points
                
                const angle = point.angle * Math.PI / 180;
                const x = centerX + Math.cos(angle) * point.distance * scale;
                const y = centerY + Math.sin(angle) * point.distance * scale;
                
                const alpha = Math.max(0.3, 1.0 - point.age);
                const intensity = Math.max(0, Math.min(255, point.intensity));
                
                ctx.fillStyle = `rgba(${Math.min(255, intensity + 100)}, ${255 - intensity * 0.5}, 100, ${alpha})`;
                ctx.beginPath();
                ctx.arc(x, y, point.age < 0.1 ? 2 : 1, 0, 2 * Math.PI);
                ctx.fill();
            });
        }
        
        // ===== Event Listeners =====
        
        // Joystick Mouse Events
        joystickContainer.addEventListener('mousedown', (e) => {
            isDragging = true;
            updateJoystickPosition(e.clientX, e.clientY);
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                updateJoystickPosition(e.clientX, e.clientY);
            }
        });
        
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                resetJoystick();
            }
        });
        
        // Joystick Touch Events
        joystickContainer.addEventListener('touchstart', (e) => {
            isDragging = true;
            const touch = e.touches[0];
            updateJoystickPosition(touch.clientX, touch.clientY);
            e.preventDefault();
        });
        
        document.addEventListener('touchmove', (e) => {
            if (isDragging && e.touches.length > 0) {
                const touch = e.touches[0];
                updateJoystickPosition(touch.clientX, touch.clientY);
                e.preventDefault();
            }
        });
        
        document.addEventListener('touchend', () => {
            if (isDragging) {
                isDragging = false;
                resetJoystick();
            }
        });
        
        // Emergency Stop
        emergencyBtn.addEventListener('click', () => {
            socket.emit('emergency_stop');
            resetJoystick();
            emergencyBtn.classList.add('glow-red');
            setTimeout(() => emergencyBtn.classList.remove('glow-red'), 500);
        });
        
        // Keyboard Controls
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                emergencyBtn.click();
            }
        });
        
        // ===== Socket Events =====
        socket.on('connect', () => {
            console.log('? Connected to robot');
            connectionStatus.textContent = '? Connected';
            connectionStatus.className = 'connection-status connected';
            
            document.getElementById('motorsIndicator').className = 'status-dot status-green';
        });
        
        socket.on('disconnect', () => {
            console.log('? Disconnected from robot');
            connectionStatus.textContent = '? Disconnected';
            connectionStatus.className = 'connection-status disconnected';
            
            // Reset all indicators
            ['motorsIndicator', 'cameraIndicator', 'lidarIndicator', 'gpsIndicator'].forEach(id => {
                document.getElementById(id).className = 'status-dot status-red';
            });
        });
        
        socket.on('system_status', (data) => {
            document.getElementById('motorsText').textContent = data.motors_ready ? 'Ready' : 'Sim';
            document.getElementById('motorsIndicator').className = 
                `status-dot ${data.motors_ready ? 'status-green' : 'status-orange'}`;
                
            document.getElementById('cameraText').textContent = data.camera_ready ? 'Online' : 'Offline';
            document.getElementById('cameraIndicator').className = 
                `status-dot ${data.camera_ready ? 'status-green' : 'status-red'}`;
                
            document.getElementById('lidarText').textContent = data.lidar_ready ? 'Active' : 'Offline';
            document.getElementById('lidarIndicator').className = 
                `status-dot ${data.lidar_ready ? 'status-green' : 'status-red'}`;
        });
        
        socket.on('motor_status_update', (motors) => {
            const formatStatus = (speed, dir) => {
                if (dir === 'stop' || speed === 0) return 'STOP';
                return `${(speed * 100).toFixed(0)}% ${dir.toUpperCase()}`;
            };
            
            const m1Status = document.getElementById('motor1Status');
            const m2Status = document.getElementById('motor2Status');
            
            m1Status.textContent = formatStatus(motors.motor1_speed, motors.motor1_dir);
            m2Status.textContent = formatStatus(motors.motor2_speed, motors.motor2_dir);
            
            // Add active class for visual feedback
            m1Status.className = motors.motor1_dir !== 'stop' ? 'motor-status motor-active' : 'motor-status';
            m2Status.className = motors.motor2_dir !== 'stop' ? 'motor-status motor-active' : 'motor-status';
        });
        
        socket.on('camera_frame', (data) => {
            if (data.image) {
                cameraFeed.src = `data:image/jpeg;base64,${data.image}`;
                cameraFeed.style.display = 'block';
                cameraOffline.style.display = 'none';
            }
        });
        
        socket.on('lidar_update', (data) => {
            lidarPoints = data.points || [];
            drawLidarMap();
        });
        
        socket.on('emergency_stop_activated', () => {
            alert('? Emergency Stop Activated!');
            resetJoystick();
            emergencyBtn.classList.add('pulse');
            setTimeout(() => emergencyBtn.classList.remove('pulse'), 2000);
        });
        
        socket.on('gps_update', (gps) => {
            document.getElementById('gpsLat').textContent = gps.lat.toFixed(6);
            document.getElementById('gpsLon').textContent = gps.lon.toFixed(6);
            document.getElementById('gpsAcc').textContent = gps.accuracy + 'm';
            document.getElementById('gpsText').textContent = 'Active';
            document.getElementById('gpsIndicator').className = 'status-dot status-green';
        });
        
        // ===== GPS Tracking =====
        function startGPSTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const gpsData = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            accuracy: Math.round(position.coords.accuracy)
                        };
                        socket.emit('gps_data', gpsData);
                    },
                    (error) => {
                        console.log('GPS Error:', error);
                        document.getElementById('gpsText').textContent = 'Error';
                        document.getElementById('gpsIndicator').className = 'status-dot status-red';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 5000
                    }
                );
            } else {
                document.getElementById('gpsText').textContent = 'Not Available';
                document.getElementById('gpsIndicator').className = 'status-dot status-red';
            }
        }
        
        // ===== Device Compatibility Functions =====
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        function isTablet() {
            return /(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(navigator.userAgent);
        }
        
        function setupDeviceOptimizations() {
            const body = document.body;
            
            if (isMobile()) {
                // Mobile optimizations
                body.classList.add('mobile-device');
                
                // Prevent zoom on double tap
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function (event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
                
                // Prevent scroll bounce
                document.addEventListener('touchmove', function(e) {
                    if (e.target.closest('.joystick-container')) {
                        return; // Allow joystick movement
                    }
                    e.preventDefault();
                }, { passive: false });
                
                // Lock orientation to landscape if possible
                if (screen.orientation && screen.orientation.lock) {
                    screen.orientation.lock('landscape').catch(() => {
                        console.log('Could not lock orientation');
                    });
                }
            }
            
            if (isTablet()) {
                body.classList.add('tablet-device');
            }
            
            // Handle device orientation changes
            window.addEventListener('orientationchange', () => {
                setTimeout(() => {
                    initJoystick();
                    drawLidarMap();
                }, 100);
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                setTimeout(() => {
                    initJoystick();
                    drawLidarMap();
                }, 100);
            });
        }
        
        // ===== Initialization =====
        window.addEventListener('load', () => {
            console.log('? Initializing Gaming Interface');
            
            // Setup device-specific optimizations
            setupDeviceOptimizations();
            
            // Initialize components
            initJoystick();
            startGPSTracking();
            
            // Start data streams
            socket.emit('request_lidar_update');
            socket.emit('request_camera_frame');
            
            console.log('? Robot Control Interface Ready');
        });
        
        // ===== Regular Data Updates =====
        setInterval(() => {
            socket.emit('request_lidar_update');
        }, 150); // LiDAR updates every 150ms
        
        setInterval(() => {
            socket.emit('request_camera_frame');
        }, 100); // Camera frames every 100ms
        
        // ===== Performance Monitoring =====
        let frameCount = 0;
        let lastFrameTime = Date.now();
        
        function updatePerformanceStats() {
            frameCount++;
            const now = Date.now();
            
            if (now - lastFrameTime >= 1000) {
                const fps = Math.round((frameCount * 1000) / (now - lastFrameTime));
                // console.log(`UI FPS: ${fps}`);
                frameCount = 0;
                lastFrameTime = now;
            }
            
            requestAnimationFrame(updatePerformanceStats);
        }
        
        requestAnimationFrame(updatePerformanceStats);
        
        // ===== Error Handling =====
        window.addEventListener('error', (e) => {
            console.error('Interface Error:', e.error);
        });
        
        // ===== Fullscreen Support =====
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch((e) => {
                    console.log('Fullscreen failed:', e);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Double-tap to toggle fullscreen
        let lastTap = 0;
        document.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            
            if (tapLength < 500 && tapLength > 0) {
                if (!e.target.closest('.joystick-container') && 
                    !e.target.closest('.emergency-btn')) {
                    toggleFullscreen();
                }
            }
            lastTap = currentTime;
        });
        
        // ===== Wake Lock (Prevent Sleep) =====
        let wakeLock = null;
        
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake lock activated');
                }
            } catch (err) {
                console.log('Wake lock failed:', err);
            }
        }
        
        // Request wake lock when interface becomes active
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                requestWakeLock();
            }
        });
        
        requestWakeLock(); // Initial wake lock request
    </script>
    
    <!-- Additional Mobile Optimizations -->
    <style>
        /* Mobile-specific styles */
        @media (max-width: 480px) {
            .top-hud {
                font-size: 10px;
                padding: 6px 15px;
                gap: 12px;
            }
            
            .info-panel {
                min-width: 140px;
                padding: 8px;
                font-size: 10px;
            }
            
            .info-panel h4 {
                font-size: 11px;
            }
            
            .joystick-container {
                width: 100px;
                height: 100px;
            }
            
            .joystick-handle {
                width: 25px;
                height: 25px;
            }
            
            .emergency-btn {
                top: -45px;
                padding: 6px 12px;
                font-size: 10px;
            }
            
            .direction-indicators .direction-label {
                font-size: 8px;
            }
            
            .dir-forward, .dir-backward {
                top: -65px;
                bottom: -65px;
            }
            
            .dir-left, .dir-right {
                left: -65px;
                right: -65px;
            }
            
            .lidar-minimap {
                width: 100px;
                height: 100px;
                top: 50px;
            }
        }
        
        /* Tablet-specific styles */
        @media (min-width: 481px) and (max-width: 1024px) {
            .joystick-container {
                width: 130px;
                height: 130px;
            }
            
            .info-panel {
                min-width: 180px;
            }
        }
        
        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .joystick-handle {
                box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
            }
            
            .emergency-btn {
                box-shadow: 0 0 20px rgba(255, 68, 68, 0.5);
            }
        }
        
        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .top-hud {
                top: 5px;
                padding: 4px 12px;
                font-size: 9px;
            }
            
            .bottom-hud {
                bottom: 5px;
            }
            
            .lidar-minimap {
                display: none; /* Hide on small landscape */
            }
            
            .info-panel {
                padding: 6px;
            }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background: #000;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .joystick-handle,
            .emergency-btn,
            .speed-bar {
                transition: none;
            }
            
            .pulse {
                animation: none;
            }
        }
        
        /* High contrast support */
        @media (prefers-contrast: high) {
            .joystick-container {
                border-color: #fff;
            }
            
            .info-panel {
                border-color: #fff;
            }
            
            .status-dot {
                border: 1px solid #fff;
            }
        }
        
        /* Touch-friendly sizing */
        .mobile-device .joystick-container,
        .tablet-device .joystick-container {
            min-width: 44px;
            min-height: 44px;
        }
        
        .mobile-device .emergency-btn,
        .tablet-device .emergency-btn {
            min-width: 44px;
            min-height: 44px;
            touch-action: manipulation;
        }
        
        /* Prevent text selection */
        .mobile-device,
        .tablet-device {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            .camera-background {
                height: 100vh;
                height: -webkit-fill-available;
            }
            
            .hud-overlay {
                height: 100vh;
                height: -webkit-fill-available;
            }
        }
        
        /* Android Chrome specific fixes */
        @media screen and (max-width: 767px) {
            .camera-background,
            .hud-overlay {
                height: 100vh;
                height: calc(100vh - env(keyboard-inset-height, 0px));
            }
        }
    </style>
</body>
</html>
